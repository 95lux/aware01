\subsection{Crystal}

\subsubsection{Calculation to Validate the Crystal Compatibility with STM32}

This section follows the procedure and calculations derived from \cite{HowSelectCompatible2025}.

To ensure the crystal provides enough energy to excite and sustain oscillation, the following condition must be satisfied:

\[
\text{Gain Margin} = \frac{g_m}{g_{m,\mathrm{crit}}} \ge 5
\]

or equivalently:

\[
\text{Gain Margin} = \frac{g_{m,\mathrm{crit\ max}} \cdot 5}{g_{m,\mathrm{crit}}} \ge 5
\]

where $g_m$ is the oscillator transconductance of the product. Each STM32 device specifies $g_m$ in the datasheet. The critical transconductance of the crystal is:

\[
gm_{crit} = 4 \cdot ESR \cdot (2 \pi F)^2 \cdot (C_0 + C_L)^2
\]

with

\[
ESR = 100~\Omega, \quad
F = 24~\text{MHz}, \quad
C_0 = 7~\text{pF}, \quad
C_L = 10~\text{pF}
\]

For the STM32H7:

\[
gm_{crit\ max} = 1.5~\mathrm{mA/V} 
\]

\cite[p.~107]{stmicroelectronicsStm32h7a3riDatasheet}

Calculating the critical transconductance:

\[
gm_{crit} = 1.0254~\mathrm{mA/V}
\]

and the gain margin:

\[
\text{Gain Margin} = \frac{gm_{crit\ max} \cdot 5}{gm_{crit}} 
= \frac{1.5 \cdot 5}{1.0254} \approx 7.31
\]

Since the gain margin is greater than 5, the crystal is compatible with the STM32H7.

\subsubsection{Calculation of Capacitors $C_{L1}$ and $C_{L2}$}

Since the chosen crystal is compatible with the STM32H7 MCU, the appropriate external load capacitor values need to be determined.

The relation between the crystal's load and shunt capacitance and the external load capacitors is given by:

\[ 
C_L - C_0 = \frac{C_{L1} \cdot C_{L2}}{C_{L1} + C_{L2}}
\]

Since the external load capacitors are generally the same $C_{L1} = C_{L2}$ results in:

\[
C_L - C_s = \frac{C_{L1} }{2} = \frac{C_{L2} }{2} 
\]

which can be rewritten as:

\[
C_{L1} = C_{L2} = 2 \cdot ( C_L - C_s )
\]

The stray capacitance $C_s$ accounts for the MCU pin capacitance and parasitic PCB capacitance. It typically ranges between $2 - 3$~pF. Many STM32 datasheets assume $C_s = 5$~pF for a conservative estimate. For this calculation, we take $C_s = 3$~pF.

For the NX2520SA-24.000000MHZ-B8 crystal with $C_L = 10$~pF, the external load capacitors are:

\[
C_{L1} = C_{L2} = 2 \cdot (10pF-3pF) = 14pF
\]

This results in a practical value that is readily available on the market:

\url{https://www.mouser.de/ProductDetail/NDK/NX2520SA-24.000000MHZ-B8?qs=w%2Fv1CP2dgqqDWn8DJbh9qA%3D%3D}
